<html>
    <head>
        <title>online game</title>
        <style>
            html { overflow: hidden; }
            #player { height: 50px; width: 50px; background-color: blue; position: absolute; }
            .otherplayer { transition: 0.1s linear; height: 50px; width: 50px;}
            #chatArea { z-index: 100; height: 400px; width: 350px; bottom: 40; overflow: hidden; position: absolute; }
            #messageInput { z-index: 100; box-sizing: border-box; position: absolute; bottom: 10; width: 350px; }
            #invMain { z-index: 1000; padding: 10px; width: 45%; left: 30%; top: 5%; position: absolute; background-color: gray; }
            .slot { z-index: 100; font-size: 18px; font-weight: bold; position: absolute; bottom: 10; height: 60px; width: 60px; background-color: rgb(187, 185, 185); margin: 10px; }
            #online-text { position: sticky; margin: 0px; }
            #cords { margin-bottom: 0px; }
            #usernameInput { margin-bottom: 10px; }
            #usernamePopup { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
            #playerMessage { margin: 5px; }
            .block { transition: 0.1s linear; }
            #wall { transition: 0.1s linear; height: 100px; width: 100px; background-color: rgb(165, 91, 42); position: absolute; }
            #hover { transition: transform 0.1s linear; position: absolute; height: 50px; width: 50px; background-color: rgba(83, 83, 83, 0.5); }
            #healthBar { z-index: 10; left: 50%; transform: translateX(-50%); position: absolute; height: 10px; width: 100px; background-color: rgb(255, 0, 0); }
            #healthBarBack { left: 50%; transform: translateX(-50%);  bottom: 85; z-index: -10; position: absolute; height: 10px; width: 100px; background-color: rgb(75, 75, 75); border: 2px solid black; }
            #sword { transition: 0.1s linear; top: -30px; left: 45px; height: 75px; width: 10px; background-color: rgb(0, 0, 0); position: absolute; transform-origin: bottom; transform: rotate(90deg); }
            #colorPicker { position: absolute; width: 200px; height: 200px; border-radius: 50%; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; z-index: 1000; }
            .color-section { position: absolute; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; transition: 0.5s ease; transform: translate(0, 0); opacity: 1; }
            .terrain { transition: 0.1s linear; z-index: -100; height: 50px; width: 50px; background-color: green; position: absolute; }
            .color-section:nth-child(1) { --dx: 75px; --dy: -75px; }
            .color-section:nth-child(2) { --dx: 100px; --dy: 0; }
            .color-section:nth-child(3) { --dx: 75px; --dy: 75px; }
            .color-section:nth-child(4) { --dx: 0; --dy: 100px; }
            .color-section:nth-child(5) { --dx: -75px; --dy: 75px; }
            .color-section:nth-child(6) { --dx: -100px; --dy: 0; }
            .color-section:nth-child(7) { --dx: -75px; --dy: -75px; }
            .color-section:nth-child(8) { --dx: 0; --dy: -100px; }
            #inventory { z-index: 10000; left: 2.5%; top: 2.5%; height: 95%; width: 95%; background-color: rgba(50, 50, 50, 0.9); position: absolute; }
            #usernameButton { transition: 0.5s ease; border: 2px solid green; background-color: white; padding: 15px; font-size: 20px; border-radius: 12px; cursor: pointer; }
            #usernameButton:hover { background-color: green; box-shadow: 0 12px 16px 0 rgba(0,0,0,0.24), 0 17px 50px 0 rgba(0,0,0,0.19); }
            #usernameInput:focus { transition: 0.5s linear; box-shadow: 0 12px 16px 0 rgba(0,0,0,0.24), 0 17px 50px 0 rgba(0,0,0,0.19); }
            #blockSelector { z-index: 1000; display: none; overflow: scroll; left: -120px; top: 80px; position: absolute; height: 200px; width: 300px; background-color: rgba(125, 125, 125, 0.5); }
            #sSquare { display: inline-block; height: 50px; width: 50px; margin: 10px; background-color: white; }
            #sRect { display: inline-block; height: 50px; width: 25px; margin: 10px; background-color: white; }
            #sCircle { display: inline-block; height: 50px; width: 50px; margin: 10px; background-color: white; border-radius: 50%; }
            #sSign { display: inline-block; height: 50px; width: 50px; margin: 10px; background-color: white; }
            #signText { position: absolute; top: 30px; left: 215px; }
            #top { width: 100%; height: 25px; }
            #objectKey { text-align: center; }
            #sTrap { display: inline-block; height: 50px; width: 50px; margin: 10px; background-color: white; }
            #sTrapText { margin: 0px; position: absolute; top: 47px; left: 16px; }
            #sTeleporter { display: inline-block; height: 50px; width: 50px; margin: 10px; background-color: white; }
            #teleportText { margin: 0px; display: inline-block; position: absolute; left: 13px; top: 120px; }
        </style>
    </head>
    <body>
        <div id="usernamePopup">
            <p id="onlinePlayers" style="margin: 0px;">online players: 0</p>
            <p id="version" style="margin-top: 0px;"></p>
            <h1>enter your username</h1>
            <input onkeydown="return /[a-z]/i.test(event.key)" maxlength="25" placeholder="username" id="usernameInput"></input><br>
            <button id="usernameButton" style="display: none;">submit</button>
            <p id="errorText" style="display: none;">get the new version to play bruh</p>
        </div>
        <div style="display: none;" id="main">
            <p id="cords"></p>
            <p id="online-text">online players: 0</p>
            <p id="object-text" style="margin: 0px;">total objects: 0</p>
            <div id="playerContainer"></div>
            <div id="player">
                <div id="sword"></div>
            </div>
            <div id="invMain" style="display: none;">
                <h1 style="text-align: center; margin: 0px; margin-bottom: 10px;">players</h1>
                <div id="playerList"></div>
            </div>
            <div id="chatArea"></div>
            <input id="messageInput" placeholder="press enter to message" maxlength="50"></input>
            <div id="slots">
                <div class="slot" id="slot-1">1</div>
                <div class="slot" id="slot-2">2<br>create</div>
                <div class="slot" id="slot-3">3<br>sword</div>
                <div class="slot" id="slot-4">4</div>
                <div class="slot" id="slot-5">5</div>
            </div>
            <div id="wall"></div>
            <div id="hover"></div>
            <div id="hoverChild" style="position: absolute;">
                <p id="hoverText" style="position: absolute; left: -40px; top: 35px; width: 200px;">F to change object</p>
                <div id="blockSelector">
                    <div id="top">
                        <p style="left: 0; margin: 0px; width: 30px; display: inline-block;"> < Q </p>
                        <p id="objectKey" style="margin: 0px; width: 220px; display: inline-block;">objects</p>
                        <p style="right: 0; margin: 0px; width: 30px; display: inline-block; position: absolute;"> E > </p>
                    </div>
                    <div id="layer1">
                        <div id="sSquare" style="background-color: blue;"></div>
                        <div id="sRect"></div>
                        <div id="sCircle"></div>
                        <div id="sSign"></div>
                        <div id="sTeleporter"></div>
                        <p id="signText">Sign</p>
                        <p id="teleportText">Warp</p>
                    </div>
                    <div id="layer2">
                        <div id="sTrap"><p id="sTrapText">Trap</p></div>
                    </div>
                </div>
            </div>
            <div id="healthBarBack">
                <div id="healthBar"></div>
            </div>
                <div id="colorPicker" style="display: none;">
                    <div class="color-section" style="background-color: red;"></div>
                    <div class="color-section" style="background-color: orange;"></div>
                    <div class="color-section" style="background-color: yellow;"></div>
                    <div class="color-section" style="background-color: green;"></div>
                    <div class="color-section" style="background-color: cyan;"></div>
                    <div class="color-section" style="background-color: blue;"></div>
                    <div class="color-section" style="background-color: purple;"></div>
                    <div class="color-section" style="background-color: gray; text-align: center; font-size: 25px">?</div>
                </div>
            </div>
            <div id="inventory" style="display: none; text-align: center;">
                <h1>inventory</h1>
            </div>
        <script type="module">
            let playerTransition = "0.1s linear";
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
            import { getDatabase, ref, set, onDisconnect, onChildAdded, get, onChildRemoved, push } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
            const firebaseConfig = {
                apiKey: "AIzaSyBdqoHJ58sFCcKpdHLw7mKUg_Bpi7xc7ok",
                authDomain: "game-10962.firebaseapp.com",
                databaseURL: "https://game-10962-default-rtdb.firebaseio.com",
                projectId: "game-10962",
                storageBucket: "game-10962.firebasestorage.app",
                messagingSenderId: "817447482404",
                appId: "1:817447482404:web:2cb0dd8608daf70197d4b1",
                measurementId: "G-W44ZYYMKLX"
            };
            const app = initializeApp(firebaseConfig);
            const database = getDatabase(app);
            let player = document.getElementById("player");
            let input = document.getElementById("messageInput");
            let invMain = document.getElementById("invMain");
            let cordsText = document.getElementById("cords");
            let onlineText = document.getElementById("online-text");
            let hoverElement = document.getElementById("hover");
            let objectText = document.getElementById("object-text");
            let sword = document.getElementById("sword");
            let healthBar = document.getElementById("healthBar");
            let healthBarBack = document.getElementById("healthBarBack");
            let inventory = document.getElementById("inventory");
            let hoverChild = document.getElementById("hoverChild");
            let keys = {};
            let objectView = 1;
            let bKey = false;
            let showInput = false;
            hoverElement.style.width = "50px";
            const urlParams = new URLSearchParams(window.location.search);
            const width = urlParams.get("width");
            const height = urlParams.get("height");
            let enteredUser = false;
            let pos = { xSize: 100, ySize: 100, x: window.innerWidth / 2 - 25, y: window.innerHeight / 2 - 50, username: "", color: "red", angle: 0, health: 100, heldItem: "none", clicked: false, deleteSword: false };
            let playerID = Math.floor(Math.random() * (10000000000 - 1 + 1)) + 1;
            let playerRef = ref(database, "players/" + playerID);
            let playerRefA = ref(database, "players/");
            let messageRef = ref(database, "messages/");
            let blockRef = ref(database, "blocks/");
            let terrainRef = ref(database, "terrain/");
            let canUseSword = true;
            let version = "0";
            let gameVersion = 1.3;
            document.getElementById("version").textContent = "version " + gameVersion;
            get(ref(database, '/version')).then((snapshot) => {
                if (snapshot.exists()) {
                    const intValue = snapshot.val();
                    if (gameVersion >= intValue) {
                        document.getElementById("version").style.color = "green";
                        document.getElementById("usernameButton").style.display = 'block';
                    } else {
                        document.getElementById("version").style.color = "red";
                        document.getElementById("usernameButton").remove();
                        document.getElementById("errorText").style.display = 'block';
                    }
                }
            })
            onDisconnect(playerRef).remove();
            pos.xSize = width;
            pos.ySize = height;
            let worldX = 0;
            let worldY = 0;
            let dead = false;
            let blocks = [];
            let terrainList = [];
            let inGame = false;
            let currentSlot = 1;
            let objectSelector = true;
            let currentObject = "cube";
            let slots = document.getElementsByClassName("slot");
            slots[0].style.left = window.innerWidth / 2 - 185 + "px";
            slots[1].style.left = window.innerWidth / 2 - 115 + "px";
            slots[2].style.left = window.innerWidth / 2 - 45 + "px";
            slots[3].style.left = window.innerWidth / 2 + 25 + "px";
            slots[4].style.left = window.innerWidth / 2 + 95 + "px";
            healthBarBack.style.left = window.innerWidth / 2 - 125 + "px";
            let wall = document.getElementById("wall");
            function updateSlotColors() {
                for (let i = 0; i < slots.length; i++) {
                    if (i + 1 === currentSlot) {
                        slots[i].style.backgroundColor = "rgb(100, 100, 100)";
                    } else {
                        slots[i].style.backgroundColor = "rgb(187, 185, 185)";
                    }
                }
            }
            for (let i = 0; i < slots.length; i++) {
                slots[i].addEventListener("click", () => {
                    currentSlot = i + 1;
                    updateSlotColors();
                });
            }
            updateSlotColors();
            document.getElementById("usernameButton").addEventListener("click", () => {
                if (document.getElementById("usernameInput").value == "") {
                    return;
                }
                document.getElementById("usernameInput").value = document.getElementById("usernameInput").value.replace(/\s+/g, '');
                push(messageRef, {
                    username: "System",
                    message: document.getElementById("usernameInput").value + " has joined the game",
                    color: pos.color
                });
                set(messageRef, null);
                pos.username = document.getElementById("usernameInput").value;
                document.getElementById("usernamePopup").style.display = "none";
                gameLoop();
                getTerrain();
                setInterval(playerSetPos, 100);
                document.getElementById("main").style.display = "block";
                let playerUsername = document.createElement("p");
                playerUsername.textContent = pos.username;
                playerUsername.style.position = "absolute";
                playerUsername.style.top = window.innerHeight / 2 - 125 + "px";
                playerUsername.style.width = window.innerWidth - 75 + "px";
                playerUsername.style.textAlign = "center";
                playerUsername.style.fontWeight = "bold";
                document.body.appendChild(playerUsername);
                onChildAdded(blockRef, (snapshot) => {
                    const block = snapshot.val();
                    let newBlock = document.createElement("div");
                    newBlock.style.height = "50px";
                    if (block.kind == "rect") {
                        newBlock.style.width = "25px";
                    } else {
                        newBlock.style.width = "50px";
                    }
                    if (block.kind == "circle") {
                        newBlock.style.borderRadius = "50%";
                    }
                    if (block.kind == "trap") {
                        newBlock.trap = true;
                        newBlock.style.backgroundImage = `repeating-linear-gradient(45deg, ${block.color}, ${block.color} 10px, white 10px, white 20px)`;
                    }
                    if (block.kind == "warp") {
                        newBlock.style.background = `linear-gradient(90deg, transparent 45%, black 45%, black 55%, transparent 55%), linear-gradient(0deg, transparent 45%, black 45%, black 55%, transparent 55%)`;
                        newBlock.warp = true;
                    }
                    newBlock.id = "block";
                    newBlock.style.backgroundColor = block.color;
                    newBlock.style.position = "absolute";
                    newBlock.style.zIndex = -1000;
                    newBlock.style.transform = "rotate(" + block.rotation + "deg)";
                    if (block.kind == "rect") {
                        newBlock.x = block.x + 12.5;
                    } else {
                        newBlock.x = block.x;
                    }
                    if (block.kind == "sign") {
                        newBlock.textContent = "sign";
                        newBlock.contentEditable = true;
                        newBlock.style.transform = "rotate(0deg)";
                    }
                    newBlock.y = block.y;
                    newBlock.classList.add("block");
                    newBlock.style.left = worldX + newBlock.x + "px";
                    newBlock.style.top = worldY + newBlock.y + "px";
                    document.body.appendChild(newBlock);
                    blocks.push(newBlock);
                });
                inGame = true;
            });
            let rotation = 0;
            document.addEventListener("keydown", (event) => {
                keys[event.key] = true;
                if (event.key == "b" && inGame && document.activeElement !== input) {
                    bKey = !bKey
                    pos.deleteSword = bKey;
                }
                if (event.key == "f" && inGame && document.activeElement !== input && currentSlot == 2) {
                    objectSelector = !objectSelector;
                }
                if (event.key == "r" && inGame && document.activeElement !== input && currentSlot == 2) {
                    rotation += 90;
                    hoverElement.style.transform = 'rotate(' + rotation + 'deg)';
                }
                if (event.key == "e" && inGame && document.activeElement !== input && currentSlot == 2) {
                    if (objectView == 1) {
                        objectView += 1;
                    }
                }
                if (event.key == "q" && inGame && document.activeElement !== input && currentSlot == 2) {
                    if (objectView == 2) {
                        objectView -= 1;
                    }
                }
                if (event.key == "Enter") {
                    if (document.activeElement !== input) {
                        input.focus();
                    } else {
                        if (input.value != "") {
                            push(messageRef, {
                                username: pos.username,
                                message: input.value,
                                color: pos.color
                            });
                        }
                        if (input.value == "/clear") {
                            push(messageRef, {
                                username: "System",
                                message: pos.username + " has cleared the objects",
                                color: pos.color
                            });
                        }
                        set(messageRef, null);
                        input.value = "";
                        input.blur();
                    }
                }
                if (event.key == "Tab") {
                    event.preventDefault();
                    if (invMain.style.display == "none") {
                        invMain.style.display = 'block';
                    } else {
                        invMain.style.display = 'none';
                    }
                }
            })
            document.addEventListener('mousemove', function(event) {
                if (objectSelector) {
                    hoverElement.style.left = event.clientX - parseInt(hoverElement.style.width) / 2 + "px";
                    hoverElement.style.top = event.clientY - 25 + "px";
                }
                let mouseX = event.clientX;
                let mouseY = event.clientY;
                let playerRect = player.getBoundingClientRect();
                let playerCenterX = playerRect.left + playerRect.width / 2;
                let playerCenterY = playerRect.top + playerRect.height / 2;
                let angle = Math.atan2(mouseY - playerCenterY, mouseX - playerCenterX);
                let angleInDegrees = angle * (180 / Math.PI);
                pos.angle = angleInDegrees | 0;
                player.style.transform = `translate(-50%, -50%) rotate(${angleInDegrees}deg)`;
            });
            document.addEventListener("keyup", (event) => {
                delete keys[event.key];
            });
            set(playerRefA, null);
            player.style.left = pos.x + "px";
            player.style.top = pos.y + "px";
            let pTime = 0;
            const f = 200;
            let canTeleport = true;
            function gameLoop(currentTime) {
                let deltaTime = (currentTime - pTime) / 1000;
                pTime = currentTime;
                const e = f * deltaTime;
                if (player) {
                    if (document.activeElement !== input && !dead) {
                        if (keys['a']) { worldX = Math.min(worldX + e, 5000); pos.x = Math.max(pos.x - e, -5000); }
                        if (keys['w']) { worldY = Math.min(worldY + e, 5000); pos.y = Math.max(pos.y - e, -5000); }
                        if (keys['s']) { worldY = Math.max(worldY - e, -5000); pos.y = Math.min(pos.y + e, 5000); }
                        if (keys['d']) { worldX = Math.max(worldX - e, -5000); pos.x = Math.min(pos.x + e, 5000); }
                        if (keys['ArrowLeft']) { worldX = Math.min(worldX + e, 5000); pos.x = Math.max(pos.x - e, -5000); }
                        if (keys['ArrowUp']) { worldY = Math.min(worldY + e, 5000); pos.y = Math.max(pos.y - e, -5000); }
                        if (keys['ArrowDown']) { worldY = Math.max(worldY - e, -5000); pos.y = Math.min(pos.y + e, 5000); }
                        if (keys['ArrowRight']) { worldX = Math.max(worldX - e, -5000); pos.x = Math.min(pos.x + e, 5000); }
                        if (keys['1']) { currentSlot = 1; }
                        if (keys['2']) { currentSlot = 2; }
                        if (keys['3']) { currentSlot = 3; }
                        if (keys['4']) { currentSlot = 4; }
                        if (keys['5']) { currentSlot = 5; }
                        if (keys[' ']) {
                            if (currentSlot == 3 && canUseSword) {
                                sword.style.transform = 'rotate(0deg)';
                                pos.clicked = true;
                                canUseSword = false;
                                setTimeout(() => {
                                    sword.style.transform = 'rotate(90deg)';
                                    pos.clicked = false;
                                }, 100);
                                setTimeout(() => {
                                    canUseSword = true;
                                }, 500);
                            }
                        }
                    }
                    cordsText.textContent = "cords: " + Math.round(worldX) + ", " + Math.round(worldY);
                    player.style.width = pos.xSize;
                    player.style.height = pos.ySize;
                    wall.style.left = worldX + 500 + "px";
                    wall.style.top = worldY + 500 + "px";
                    hoverChild.style.display = hoverElement.style.display;
                    hoverChild.style.left = hoverElement.style.left;
                    hoverChild.style.top = hoverElement.style.top;
                    document.getElementById("usernameInput").maxlength = 25;
                    blocks.forEach(block => {
                        let blockRect = block.getBoundingClientRect();
                        let playerRect = player.getBoundingClientRect();
                        if ((keys['a'] || keys['ArrowLeft']) && playerRect.left < blockRect.right && playerRect.left > blockRect.left && playerRect.bottom > blockRect.top && playerRect.top < blockRect.bottom && block.style.backgroundColor != pos.color) {
                            pos.x += e; worldX -= e;
                        }
                        if ((keys['d'] || keys['ArrowRight']) && playerRect.right > blockRect.left && playerRect.right < blockRect.right && playerRect.bottom > blockRect.top && playerRect.top < blockRect.bottom && block.style.backgroundColor != pos.color) {
                            pos.x -= e; worldX += e;
                        }
                        if ((keys['w'] || keys['ArrowUp']) && playerRect.top < blockRect.bottom && playerRect.top > blockRect.top && playerRect.right > blockRect.left && playerRect.left < blockRect.right && block.style.backgroundColor != pos.color) {
                            pos.y += e; worldY -= e;
                        }
                        if ((keys['s'] || keys['ArrowDown']) && playerRect.bottom > blockRect.top && playerRect.bottom < blockRect.bottom && playerRect.right > blockRect.left && playerRect.left < blockRect.right && block.style.backgroundColor != pos.color) {
                            pos.y -= e; worldY += e;
                        }
                        if (playerRect.left < blockRect.right && playerRect.right > blockRect.left && playerRect.top < blockRect.bottom && playerRect.bottom > blockRect.top && block.trap == true && block.style.backgroundColor != pos.color) {
                            pos.health -= 2;
                        }
                        if (playerRect.left < blockRect.right && playerRect.right > blockRect.left && playerRect.top < blockRect.bottom && playerRect.bottom > blockRect.top && block.warp == true && canTeleport) {
                            let warpBlocks = blocks.filter(block => block.warp === true);
                            let otherWarpBlocks = warpBlocks.filter(warp => warp !== block);
                            if (otherWarpBlocks.length > 0) {
                                let randomIndex = Math.floor(Math.random() * otherWarpBlocks.length);
                                let randomWarp = otherWarpBlocks[randomIndex];
                                worldX -= parseInt(randomWarp.x) - parseInt(block.x);
                                worldY -= parseInt(randomWarp.y) - parseInt(block.y);
                                pos.x += parseInt(randomWarp.x) - parseInt(block.x);
                                pos.y += parseInt(randomWarp.y) - parseInt(block.y);
                                canTeleport = false;
                                setTimeout(() => {
                                    canTeleport = true;
                                }, 1000);
                            }
                        }
                    });
                    if (!objectSelector) {
                        document.getElementById("blockSelector").style.display = "block";
                    } else {
                        document.getElementById("blockSelector").style.display = 'none';
                    }
                    terrainList.forEach(block => {
                        let blockRect = block.getBoundingClientRect();
                        let playerRect = player.getBoundingClientRect();
                        if ((keys['a'] || keys['ArrowLeft']) && playerRect.left < blockRect.right && playerRect.left > blockRect.left && playerRect.bottom > blockRect.top && playerRect.top < blockRect.bottom) {
                            pos.x += e; worldX -= e;
                        }
                        if ((keys['d'] || keys['ArrowRight']) && playerRect.right > blockRect.left && playerRect.right < blockRect.right && playerRect.bottom > blockRect.top && playerRect.top < blockRect.bottom) {
                            pos.x -= e; worldX += e;
                        }
                        if ((keys['w'] || keys['ArrowUp']) && playerRect.top < blockRect.bottom && playerRect.top > blockRect.top && playerRect.right > blockRect.left && playerRect.left < blockRect.right) {
                            pos.y += e; worldY -= e;
                        }
                        if ((keys['s'] || keys['ArrowDown']) && playerRect.bottom > blockRect.top && playerRect.bottom < blockRect.bottom && playerRect.right > blockRect.left && playerRect.left < blockRect.right) {
                            pos.y -= e; worldY += e;
                        }
                    });
                    healthBar.style.width = pos.health + "%";
                    if (currentSlot == 2) {
                        hoverElement.style.display = "block";
                    } else {
                        hoverElement.style.display = "none";
                    }
                    if (currentSlot == 3) {
                        sword.style.display = 'block';
                        pos.heldItem = "sword";
                    } else {
                        sword.style.display = 'none';
                        pos.heldItem = "none";
                    }
                    if (objectView == 1) {
                        document.getElementById("objectKey").textContent = "objects";
                        document.getElementById("layer1").style.display = 'inherit';
                        document.getElementById("layer2").style.display = 'none';
                    }
                    if (objectView == 2) {
                        document.getElementById("objectKey").textContent = "traps";
                        document.getElementById("layer1").style.display = 'none';
                        document.getElementById("layer2").style.display = 'inherit';
                    }
                    if (pos.health <= 0 && !dead) {
                        pos.health = 100;
                        dead = true;
                        let color = pos.color;
                        let color2 = player.style.backgroundColor;
                        pos.color = "rgba(100, 100, 100, 0.5)";
                        player.style.backgroundColor = "rgba(100, 100, 100, 0.5)"
                        setTimeout(() => {
                            pos.color = color;
                            player.style.backgroundColor = color2;
                            dead = false;
                        }, 5000);
                    }
                    if (pos.health > 100) {
                        document.body.textContent = "stop cheating cheater";
                        return;
                    }
                    if (pos.username == "") {
                        document.body.textContent = "stop cheating cheater";
                        return;
                    }
                    if (bKey) {
                        sword.style.backgroundColor = "red";
                    } else {
                        sword.style.backgroundColor = "black";
                    }
                    if (currentSlot == 3) {
                        blocks.forEach(block => {
                            if (currentSlot == 3 && sword.style.display == 'block' && bKey && pos.clicked) {
                                let swordRect = sword.getBoundingClientRect();
                                let blockRect = block.getBoundingClientRect();
                                if (swordRect.left < blockRect.right && swordRect.right > blockRect.left && swordRect.top < blockRect.bottom && swordRect.bottom > blockRect.top) {
                                    block.remove();
                                    blocks = blocks.filter(b => b !== block);
                                }
                            }
                        });
                    }
                    if (pos.health < 100) {
                        pos.health += 0.125;
                    }
                    requestAnimationFrame(gameLoop);
                    getPlayers();
                    renderTerrain();
                    getObjectCount();
                    updateSlotColors();
                    blocks.forEach(block => {
                        if (block.x + worldX >= -200 && block.x + worldX <= window.innerWidth + 200 && block.y + worldY >= -200 && block.y + worldY <= window.innerHeight + 200) {
                            block.style.left = worldX + block.x + "px";
                            block.style.top = worldY + block.y + "px";
                            block.style.display = 'block';
                        } else {
                            block.style.display = 'none';
                        }
                    });
                }
            }
            onChildAdded(messageRef, (snapshot) => {
                const message = snapshot.val();
                let messageElement;
                if (message.message.includes("***")) {
                    message.message = message.message.replace("***", "");
                    messageElement = document.createElement("h1");
                } else {
                    messageElement = document.createElement("p");
                }
                messageElement.id = "playerMessage";
                if (message.color != "red") {
                    messageElement.style.color = message.color;
                }
                if (message.username == "System") {
                    messageElement.style.fontStyle = "italic";
                    messageElement.style.color = "gray";
                }
                if (message.message.includes("/clear")) {
                    blocks.forEach(block => {
                        block.remove();
                    });
                    blocks = [];
                    set(blockRef, null);
                }
                if (message.message.includes("/playsound")) {
                    let command = message.message.split(' ');
                    let sound = command[1];
                    let audioElement = document.createElement("audio");
                    audioElement.src = "https://raw.githubusercontent.com/seaotter6382/seaotter6382.github.io/refs/heads/main/sounds/" + sound + ".mp3";
                    audioElement.autoplay = true;
                    document.body.appendChild(audioElement);
                }
                messageElement.textContent = message.username + ": " + message.message;
                const chatArea = document.getElementById("chatArea");
                const inputElement = document.getElementById("messageInput");
                chatArea.appendChild(messageElement);
                chatArea.scrollTop = chatArea.scrollHeight;
            });
            function getPlayers() {
                const playerRef = ref(database, 'players');
                get(playerRef)
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const items = snapshot.val();
                            for (let key in items) {
                                const otherPlayer = items[key];
                                if (key != playerID) {
                                    let otherPlayerDiv = document.getElementById(key);
                                    let otherPlayerUsername = document.getElementById(key + "username");
                                    let otherPlayerHealth = document.getElementById(key + "health");
                                    let otherPlayerHealthBack = document.getElementById(key + "healthBack");
                                    let otherPlayerSword = document.getElementById(key + "sword");
                                    if (!otherPlayerHealthBack) {
                                        otherPlayerHealthBack = document.createElement("div");
                                        otherPlayerHealthBack.id = key + "healthBack";
                                        otherPlayerHealthBack.style.height = "10px";
                                        otherPlayerHealthBack.style.width = "100px";
                                        otherPlayerHealthBack.style.backgroundColor = "rgb(75, 75, 75)";
                                        otherPlayerHealthBack.style.position = "absolute";
                                        otherPlayerHealthBack.style.transition = playerTransition;
                                        otherPlayerHealthBack.style.zIndex = 99;
                                        document.getElementById("playerContainer").appendChild(otherPlayerHealthBack);
                                    }
                                    if (!otherPlayerHealth) {
                                        otherPlayerHealth = document.createElement("div");
                                        otherPlayerHealth.id = key + "health";
                                        otherPlayerHealth.style.height = "10px";
                                        otherPlayerHealth.style.width = "100px";
                                        otherPlayerHealth.style.backgroundColor = "rgb(255, 0, 0)";
                                        otherPlayerHealth.style.position = "absolute";
                                        otherPlayerHealth.style.transition = playerTransition;
                                        otherPlayerHealth.style.zIndex = 100;
                                        document.getElementById(key + "healthBack").appendChild(otherPlayerHealth);
                                    }
                                    if (!otherPlayerUsername) {
                                        otherPlayerUsername = document.createElement("p");
                                        otherPlayerUsername.id = key + "username";
                                        otherPlayerUsername.style.width = "500px";
                                        otherPlayerUsername.style.textAlign = "center";
                                        otherPlayerUsername.style.position = "absolute";
                                        otherPlayerUsername.style.fontWeight = "bold";
                                        otherPlayerUsername.style.transition = playerTransition;
                                        otherPlayerUsername.style.zIndex = 100;
                                        document.getElementById("playerContainer").appendChild(otherPlayerUsername);
                                    }
                                    if (!otherPlayerDiv) {
                                        otherPlayerDiv = document.createElement("div");
                                        otherPlayerDiv.id = key;
                                        otherPlayerDiv.classList.add("otherPlayer");
                                        otherPlayerDiv.style.position = "absolute";
                                        document.getElementById("playerContainer").appendChild(otherPlayerDiv);
                                    }
                                    if (!otherPlayerSword) {
                                        otherPlayerSword = document.createElement("div");
                                        otherPlayerSword.style.height = "75px";
                                        otherPlayerSword.style.width = "10px";
                                        otherPlayerSword.id = key + "sword";
                                        otherPlayerSword.style.backgroundColor = "rgb(0, 0, 0)";
                                        otherPlayerSword.style.position = "absolute";
                                        otherPlayerSword.style.transition = playerTransition;
                                        otherPlayerSword.style.transformOrigin = "bottom";
                                        otherPlayerSword.style.transform = "rotate(90deg)";
                                        otherPlayerDiv.appendChild(otherPlayerSword);
                                    }
                                    if (otherPlayer.heldItem == "sword") {
                                        otherPlayerSword.style.display = 'block';
                                    } else {
                                        otherPlayerSword.style.display = 'none';
                                    }
                                    otherPlayerDiv.style.left = worldX + otherPlayer.x + "px";
                                    otherPlayerDiv.style.top = worldY + otherPlayer.y + "px";
                                    otherPlayerHealth.style.width = otherPlayer.health + "%";
                                    otherPlayerDiv.style.transform = `translate(-50%, -50%) rotate(${otherPlayer.angle}deg)`;
                                    otherPlayerUsername.textContent = otherPlayer.username;
                                    otherPlayerUsername.style.left = worldX + otherPlayer.x + otherPlayerDiv.offsetWidth / 2 - otherPlayerUsername.offsetWidth / 2 - 25 + "px";
                                    otherPlayerUsername.style.top = worldY + otherPlayer.y - 75 + "px";
                                    otherPlayerHealthBack.style.left = worldX + otherPlayer.x + otherPlayerDiv.offsetWidth / 2 - 75 + "px";
                                    otherPlayerHealthBack.style.top = worldY + otherPlayer.y + 40 + "px";
                                    otherPlayerDiv.style.backgroundColor = otherPlayer.color;
                                    otherPlayerSword.style.left = "45px";
                                    otherPlayerSword.style.top = "-30px";
                                    if (otherPlayer.deleteSword == true && otherPlayer.clicked == true) {
                                        otherPlayerSword.style.backgroundColor = "red";
                                        blocks.forEach(block => {
                                            let swordRect = otherPlayerSword.getBoundingClientRect();
                                            let blockRect = block.getBoundingClientRect();
                                            if (swordRect.left < blockRect.right && swordRect.right > blockRect.left && swordRect.top < blockRect.bottom && swordRect.bottom > blockRect.top) {
                                                block.remove();
                                                blocks = blocks.filter(b => b !== block);
                                            }
                                        });
                                    } else {
                                        otherPlayerSword.style.backgroundColor = "black";
                                    }
                                    if (otherPlayer.clicked == true) {
                                        otherPlayerSword.style.transform = 'rotate(0deg)';
                                        setTimeout(() => {
                                            otherPlayerSword.style.transform = 'rotate(90deg)';
                                        }, 100);
                                    }
                                    if (otherPlayer.xSize != null) {
                                        otherPlayerDiv.style.width = otherPlayer.xSize;
                                    }
                                    if (otherPlayer.ySize != null) {
                                        otherPlayerDiv.style.height = otherPlayer.ySize;
                                    }
                                    const playerRect = player.getBoundingClientRect();
                                    if (otherPlayerSword && otherPlayerSword.style.display == 'block' && otherPlayer.color != pos.color) {
                                        const otherPlayerSwordRect = otherPlayerSword.getBoundingClientRect();
                                        if (otherPlayerSwordRect.left < playerRect.right && otherPlayerSwordRect.right > playerRect.left && otherPlayerSwordRect.top < playerRect.bottom && otherPlayerSwordRect.bottom > playerRect.top) {
                                            if (!dead && otherPlayer.clicked == true) {
                                                pos.health -= 5;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    });
                onChildRemoved(playerRef, (snapshot) => {
                    const playerId = snapshot.key;
                    const otherPlayerDiv = document.getElementById(playerId);
                    const otherPlayerUsername = document.getElementById(playerId + "username");
                    const otherPlayerHealth = document.getElementById(playerId + "healthBack");
                    if (otherPlayerDiv && otherPlayerUsername) {
                        otherPlayerDiv.remove();
                        otherPlayerUsername.remove();
                        otherPlayerHealth.remove();
                    }
                });
            }
            function getOnlinePlayers() {
                document.getElementById("playerList").innerHTML = "";
                get(playerRefA).then((snapshot) => {
                    if (snapshot.exists()) {
                        let p = "";
                        const players = snapshot.val();
                        for (let key in players) {
                            const otherPlayer = players[key];
                            let newText = document.createElement("p");
                            newText.textContent = otherPlayer.username;
                            newText.style.textAlign = "center";
                            newText.style.margin = "0px";
                            if (!otherPlayer.color == "red") {
                                newText.style.color = otherPlayer.color;
                            }
                            document.getElementById("playerList").appendChild(newText);
                        }
                        const totalPlayers = Object.keys(players).length;
                        onlineText.textContent = "online players: " + totalPlayers;
                        document.getElementById("onlinePlayers").textContent = "online players: " + totalPlayers;
                    }
                });
            }
            let canPlaceBlock = true;
            const blockCooldown = 250;
            document.addEventListener("click", (event) => {
                if (currentSlot == 2 && canPlaceBlock && !dead && objectSelector) {
                    let clickedElement = document.elementFromPoint(event.clientX, event.clientY);
                    if (clickedElement.id == "player" || clickedElement.id == "wall" || clickedElement.id == "block") {
                        return;
                    }
                    let color;
                    if (pos.color == "red") {
                        color = "blue";
                    } else {
                        color = pos.color;
                    }
                    push(blockRef, {
                        x: event.clientX - worldX - 25,
                        y: event.clientY - worldY - 25,
                        color: color,
                        kind: currentObject,
                        rotation: rotation
                    });
                    canPlaceBlock = false;
                    setTimeout(() => {
                        canPlaceBlock = true;
                    }, blockCooldown);
                }
                if (currentSlot == 3 && canUseSword) {
                    sword.style.transform = 'rotate(0deg)';
                    pos.clicked = true;
                    canUseSword = false;
                    setTimeout(() => {
                        sword.style.transform = 'rotate(90deg)';
                        pos.clicked = false;
                    }, 100);
                    setTimeout(() => {
                        canUseSword = true;
                    }, 500);
                }
            });
            function getObjectCount() {
                let blockElements = document.getElementsByClassName("block");
                objectText.textContent = "total objects: " + blockElements.length;
            }
            const colorPicker = document.getElementById("colorPicker");
            const colorSections = document.querySelectorAll(".color-section");
            player.addEventListener("click", (event) => {
                if (pos.health == 100) {
                    const rect = player.getBoundingClientRect();
                    const x = rect.left + rect.width / 2;
                    const y = rect.top + rect.height / 2;
                    colorPicker.style.left = `${x - 100}px`;
                    colorPicker.style.top = `${y - 100}px`;
                    colorPicker.style.display = "flex";
                    colorSections.forEach((section, index) => {
                        section.style.opacity = 0;
                        section.style.visibility = "hidden";
                        setTimeout(() => {
                            section.style.visibility = "visible";
                            section.style.opacity = 1;
                            section.style.transform = `translate(var(--dx), var(--dy))`;
                        }, index * 100);
                    });
                }
            });
            colorSections.forEach((section) => {
                section.addEventListener("click", (event) => {
                    const rect = player.getBoundingClientRect();
                    const targetX = rect.left + rect.width / 2 - 25;
                    const targetY = rect.top + rect.height / 2 - 25;
                    const selectedColor = event.target.style.backgroundColor;
                    section.style.transition = "transform 0.5s ease, opacity 0.5s ease";
                    section.style.transform = `translate(0px, 0px)`;
                    colorSections.forEach((otherSection) => {
                        if (otherSection !== section) {
                            otherSection.style.opacity = 0;
                        }
                    });
                    setTimeout(() => {
                        player.style.backgroundColor = selectedColor;
                        if (selectedColor == "red") {
                            pos.color = "rgb(255, 0, 0)"
                        } else {
                            pos.color = selectedColor
                        }
                        if (selectedColor == "gray") {
                            let randomColor =  "#" + ((1 << 24) + (Math.floor(Math.random() * 256) << 16) + (Math.floor(Math.random() * 256) << 8) + Math.floor(Math.random() * 256)).toString(16).slice(1);
                            pos.color = randomColor;
                            player.style.backgroundColor = randomColor;
                        }
                        colorPicker.style.display = "none";
                        colorSections.forEach((otherSection) => {
                            otherSection.style.transform = "translate(0, 0)";
                            otherSection.style.opacity = 1;
                            otherSection.style.visibility = "hidden";
                        });
                    }, 500);
                });
            });
            document.addEventListener("click", (event) => {
                if (!colorPicker.contains(event.target) && event.target !== player) {
                    colorSections.forEach((section) => {
                        section.style.transform = "translate(0, 0)";
                        section.style.opacity = 0;
                        section.style.visibility = "hidden";
                    });
                    setTimeout(() => {
                        colorPicker.style.display = "none";
                    }, 500);
                }
            });
            function getTerrain() {
                get(terrainRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        let data = snapshot.val()
                        for (let key in data) {
                            if (data.hasOwnProperty(key)) {
                                const terrain = data[key];
                                const posX = terrain.posX;
                                const posY = terrain.posY;
                                const newTerrain = document.createElement("div");
                                newTerrain.style.left = worldX + posX + "px";
                                newTerrain.style.top = worldY + posY + "px";
                                newTerrain.x = posX;
                                newTerrain.y = posY;
                                newTerrain.style.width = terrain.size;
                                newTerrain.style.height = terrain.size;
                                newTerrain.id = key;
                                newTerrain.classList.add("terrain");
                                document.body.appendChild(newTerrain);
                                terrainList.push(newTerrain);
                            }
                        }
                        } else {
                        for (let i = 0; i < 500; i++) {
                            push(terrainRef, {
                                posX: Math.floor(Math.random() * 10001) - 5000,
                                posY: Math.floor(Math.random() * 10001) - 5000,
                                size: Math.floor(Math.random() * (200 - 50 + 1)) + 50
                            });
                        }
                    }
                });
            }
            function renderTerrain() {
                for (const item of terrainList) {
                    if (item.x + worldX >= -200 && item.x + worldX <= window.innerWidth + 200 && item.y + worldY >= -200 && item.y + worldY <= window.innerHeight + 200 ) {
                        item.style.left = worldX + item.x + "px";
                        item.style.top = worldY + item.y + "px";
                        item.style.display = "block";
                    } else {
                        item.style.display = "none";
                    }
                }
            }
            document.getElementById("sSquare").addEventListener("click", () => {
                currentObject = "cube";
                document.getElementById("sSquare").style.backgroundColor = "blue";
                document.getElementById("sRect").style.backgroundColor = "white";
                document.getElementById("sCircle").style.backgroundColor = "white";
                document.getElementById("sSign").style.backgroundColor = "white";
                document.getElementById("sTrap").style.backgroundColor = "white";
                document.getElementById("sTeleporter").style.backgroundColor = "white";
                document.getElementById("hover").style.width = "50px";
                document.getElementById("hover").style.borderRadius = "0%";
            })
            document.getElementById("sRect").addEventListener("click", () => {
                currentObject = "rect";
                document.getElementById("sRect").style.backgroundColor = "blue";
                document.getElementById("sSquare").style.backgroundColor = "white";
                document.getElementById("sCircle").style.backgroundColor = "white";
                document.getElementById("sSign").style.backgroundColor = "white";
                document.getElementById("sTrap").style.backgroundColor = "white";
                document.getElementById("sTeleporter").style.backgroundColor = "white";
                document.getElementById("hover").style.width = "25px";
                document.getElementById("hover").style.borderRadius = "0%";
            })
            document.getElementById("sCircle").addEventListener("click", () => {
                currentObject = "circle";
                document.getElementById("sRect").style.backgroundColor = "white";
                document.getElementById("sSquare").style.backgroundColor = "white";
                document.getElementById("sCircle").style.backgroundColor = "blue";
                document.getElementById("sSign").style.backgroundColor = "white";
                document.getElementById("sTrap").style.backgroundColor = "white";
                document.getElementById("sTeleporter").style.backgroundColor = "white";
                document.getElementById("hover").style.width = "50px";
                document.getElementById("hover").style.borderRadius = "50%";
            })
            document.getElementById("sSign").addEventListener("click", () => {
                currentObject = "sign";
                document.getElementById("sRect").style.backgroundColor = "white";
                document.getElementById("sSquare").style.backgroundColor = "white";
                document.getElementById("sCircle").style.backgroundColor = "white";
                document.getElementById("sSign").style.backgroundColor = "blue";
                document.getElementById("sTrap").style.backgroundColor = "white";
                document.getElementById("sTeleporter").style.backgroundColor = "white";
                document.getElementById("hover").style.width = "50px";
                document.getElementById("hover").style.borderRadius = "0%";
            })
            document.getElementById("sTrap").addEventListener("click", () => {
                currentObject = "trap";
                document.getElementById("sRect").style.backgroundColor = "white";
                document.getElementById("sSquare").style.backgroundColor = "white";
                document.getElementById("sCircle").style.backgroundColor = "white";
                document.getElementById("sSign").style.backgroundColor = "white";
                document.getElementById("sTrap").style.backgroundColor = "blue";
                document.getElementById("sTeleporter").style.backgroundColor = "white";
                document.getElementById("hover").style.width = "50px";
                document.getElementById("hover").style.borderRadius = "0%";
            })
            document.getElementById("sTeleporter").addEventListener("click", () => {
                currentObject = "warp";
                document.getElementById("sRect").style.backgroundColor = "white";
                document.getElementById("sSquare").style.backgroundColor = "white";
                document.getElementById("sCircle").style.backgroundColor = "white";
                document.getElementById("sSign").style.backgroundColor = "white";
                document.getElementById("sTrap").style.backgroundColor = "white";
                document.getElementById("sTeleporter").style.backgroundColor = "blue";
                document.getElementById("hover").style.width = "50px";
                document.getElementById("hover").style.borderRadius = "0%";
            })
            function playerSetPos() {
                set(playerRef, pos);
            }
            setInterval(getOnlinePlayers, 100);
            set(playerRefA, null);
        </script>
    </body>
</html>